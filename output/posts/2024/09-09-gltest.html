<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/assets/app.css">
    <script type="text/javascript" src="/assets/app.js"></script>
    
    <title>GLtest</title>
    <meta name="description" content="First steps with OpenGL in Elixir">
  
  </head>

  <body class="bg-nor-easter text-smurf-blood">
    <div class="flex h-60 min-h-screen flex-col items-center">
      <header class="bg-bludacris p-10 my-4 lg:mt-10 lg:mb-14">
        <h1><a href="https://andyleclair.dev/">andy@andyleclair.dev</a>$><span class="blink">_</span></h1>
      </header>
      <main class="container mx-auto relative grow min-h-96 flex-1 p-4 items-center">
        
  <article class="mx-auto prose sm:prose-sm md:prose-md lg:prose-xl prose-pre:bg-codebg">
    <h1>GLtest</h1>
    <h3>First steps with OpenGL in Elixir</h3>
    <h3><a href="https://www.youtube.com/watch?v=7ny2t1I6aTo">Related Listening</a></h3>
    <p class="text-smurf-blood">Posted on 2024-09-09</p>
    <p>
Inspired by <a href="https://elixirforum.com/t/opengl-rendered-breakout-clone-in-elixir/65250/15">this thread on Elixir Forum</a> I wanted to mess around with graphics programming in Elixir. I haven’t really touched graphics
programming since I was in college (go huskies!) but I remember it being a lot of fun. Elixir is 
pretty fast and I know a few performance tricks I’ve learned on the job, so let’s see how we can do.</p>
<p>
<a href="https://wtfleming.github.io/blog/getting-started-opengl-elixir/">Other</a> <a href="https://hidnasio.github.io/elixir/wxerlang/2022/06/29/advance-wx-erlang-hello-world.html">people</a> have mentioned methods to get at some of the OpenGL macros that are in Erlang, so we can start with that. We’ll need those to interact with OpenGL and wxWidgets.</p>
<pre><code class="makeup fish"><span class="nf">mix</span><span class="w"> </span><span class="s">new</span><span class="w"> </span><span class="nv">--</span><span class="nv">sup</span><span class="w"> </span><span class="s">gltest</span><span class="w"> </span><span class="k">&amp;&amp;</span><span class="w"> </span><span class="nf">cd</span><span class="w"> </span><span class="s">gltest</span><span class="w">
</span><span class="nf">mkdir</span><span class="w"> </span><span class="s">src/</span></code></pre>
<p>
These files are lifted directly from <a href="https://github.com/harrisi/elixir_breakout/tree/main/src">here</a></p>
<pre><code class="erlang">%% src/gl_const.erl
-module(gl_const).
-compile(nowarn_export_all).
-compile(export_all).

-include_lib(&quot;wx/include/gl.hrl&quot;).

gl_depth_test() -&gt; ?GL_DEPTH_TEST.

gl_lequal() -&gt; ?GL_LEQUAL.
gl_color_buffer_bit() -&gt; ?GL_COLOR_BUFFER_BIT.

gl_depth_buffer_bit() -&gt; ?GL_DEPTH_BUFFER_BIT.

gl_triangles() -&gt; ?GL_TRIANGLES.
gl_array_buffer() -&gt; ?GL_ARRAY_BUFFER.
gl_element_array_buffer() -&gt; ?GL_ELEMENT_ARRAY_BUFFER.
gl_static_draw() -&gt; ?GL_STATIC_DRAW.

gl_vertex_shader() -&gt; ?GL_VERTEX_SHADER.
gl_fragment_shader() -&gt; ?GL_FRAGMENT_SHADER.

gl_compile_status() -&gt; ?GL_COMPILE_STATUS.
gl_link_status() -&gt; ?GL_LINK_STATUS.

gl_float() -&gt; ?GL_FLOAT.
gl_false() -&gt; ?GL_FALSE.
gl_true() -&gt; ?GL_TRUE.
gl_unsigned_int() -&gt; ?GL_UNSIGNED_INT.
gl_unsigned_byte() -&gt; ?GL_UNSIGNED_BYTE.

gl_front_and_back() -&gt; ?GL_FRONT_AND_BACK.
gl_line() -&gt; ?GL_LINE.
gl_fill() -&gt; ?GL_FILL.
gl_debug_output() -&gt; ?GL_DEBUG_OUTPUT.
gl_texture_2d() -&gt; ?GL_TEXTURE_2D.
gl_texture_wrap_s() -&gt; ?GL_TEXTURE_WRAP_S.
gl_texture_wrap_t() -&gt; ?GL_TEXTURE_WRAP_T.
gl_texture_min_filter() -&gt; ?GL_TEXTURE_MIN_FILTER.
gl_texture_mag_filter() -&gt; ?GL_TEXTURE_MAG_FILTER.
gl_rgb() -&gt; ?GL_RGB.
gl_rgba() -&gt; ?GL_RGBA.
gl_multisample() -&gt; ?GL_MULTISAMPLE.
gl_luminance() -&gt; ?GL_LUMINANCE.

gl_texture0() -&gt; ?GL_TEXTURE0.

gl_cull_face() -&gt; ?GL_CULL_FACE.
gl_back() -&gt; ?GL_BACK.
gl_front() -&gt; ?GL_FRONT.
gl_ccw() -&gt; ?GL_CCW.
gl_cw() -&gt; ?GL_CW.

gl_info_log_length() -&gt; ?GL_INFO_LOG_LENGTH.

gl_blend() -&gt; ?GL_BLEND.
gl_src_alpha() -&gt; ?GL_SRC_ALPHA.
gl_one() -&gt; ?GL_ONE.
gl_one_minus_src_alpha() -&gt; ?GL_ONE_MINUS_SRC_ALPHA.

gl_repeat() -&gt; ?GL_REPEAT.
gl_linear() -&gt; ?GL_LINEAR.
gl_nearest() -&gt; ?GL_NEAREST.

gl_framebuffer() -&gt; ?GL_FRAMEBUFFER.
gl_renderbuffer() -&gt; ?GL_RENDERBUFFER.
gl_color_attachment0() -&gt; ?GL_COLOR_ATTACHMENT0.
gl_framebuffer_complete() -&gt; ?GL_FRAMEBUFFER_COMPLETE.
gl_read_framebuffer() -&gt; ?GL_READ_FRAMEBUFFER.
gl_draw_framebuffer() -&gt; ?GL_DRAW_FRAMEBUFFER.

gl_texture_env() -&gt; ?GL_TEXTURE_ENV.
gl_texture_env_mode() -&gt; ?GL_TEXTURE_ENV_MODE.
gl_replace() -&gt; ?GL_REPLACE.</code></pre>
<pre><code class="erlang">
%% src/wx_const.erl
-module(wx_const).
-compile(nowarn_export_all).
-compile(export_all).

-include_lib(&quot;wx/include/wx.hrl&quot;).

wx_id_any() -&gt; ?wxID_ANY.
wx_gl_rgba() -&gt; ?WX_GL_RGBA.

wx_gl_doublebuffer() -&gt; ?WX_GL_DOUBLEBUFFER.
wx_gl_depth_size() -&gt; ?WX_GL_DEPTH_SIZE.
wx_gl_forward_compat() -&gt; ?WX_GL_FORWARD_COMPAT.

wxk_left() -&gt; ?WXK_LEFT.
wxk_right() -&gt; ?WXK_RIGHT.
wxk_up() -&gt; ?WXK_UP.
wxk_down() -&gt; ?WXK_DOWN.
wxk_space() -&gt; ?WXK_SPACE.
wxk_raw_control() -&gt; ?WXK_RAW_CONTROL.

wx_gl_major_version() -&gt; ?WX_GL_MAJOR_VERSION.

wx_gl_minor_version() -&gt; ?WX_GL_MINOR_VERSION.

wx_gl_core_profile() -&gt; ?WX_GL_CORE_PROFILE.
wx_gl_sample_buffers() -&gt; ?WX_GL_SAMPLE_BUFFERS.

wx_gl_samples() -&gt; ?WX_GL_SAMPLES.

wx_null_cursor() -&gt; ?wxNullCursor.
wx_cursor_blank() -&gt; ?wxCURSOR_BLANK.
wx_cursor_cross() -&gt; ?wxCURSOR_CROSS.

wx_fontfamily_default() -&gt; ?wxFONTFAMILY_DEFAULT.
wx_fontfamily_teletype() -&gt; ?wxFONTFAMILY_TELETYPE.
wx_normal() -&gt; ?wxNORMAL.
wx_fontstyle_normal() -&gt; ?wxFONTSTYLE_NORMAL.
wx_fontweight_bold() -&gt; ?wxFONTWEIGHT_BOLD.
wx_fontweight_normal() -&gt; ?wxFONTWEIGHT_NORMAL.</code></pre>
<p>
Also add wx to <code class="inline">extra_applications</code> in <code class="inline">mix.exs</code>:</p>
<pre><code class="elixir">  def application do
    [
      extra_applications: [:logger, :wx]
    ]
  end</code></pre>
<p>
For reference, this is the link to the Erlang WX documentation: <a href="https://www.erlang.org/doc/apps/wx/chapter.html">https://www.erlang.org/doc/apps/wx/chapter.html</a></p>
<p>
Following along here with <a href="https://ianhedoesit.com/blog/triangle.html">Ian’s Triangle post</a>, we will also add the records from wx.hrl to our project:</p>
<pre><code class="elixir">defmodule WxRecords do
  require Record

  for {type, record} &lt;- Record.extract_all(from_lib: &quot;wx/include/wx.hrl&quot;) do
    Record.defrecord(type, record)
  end
end</code></pre>
<p>
Finally, we can add a module to render our window!</p>
<pre><code class="elixir">defmodule GlTest.Window do
  import WxRecords

  @behaviour :wx_object

  def start_link(_) do
    :wx_object.start_link(__MODULE__, [], [])
    {:ok, self()}
  end

  @impl :wx_object
  def init(_) do
    opts = [size: {800, 600}]
    wx = :wx.new()
    frame = :wxFrame.new(wx, :wx_const.wx_id_any(), ~c&quot;Hello&quot;, opts)
    :wxWindow.connect(frame, :close_window)

    :wxFrame.show(frame)

    gl_attrib = [
      attribList: [
        :wx_const.wx_gl_core_profile(),
        :wx_const.wx_gl_major_version(),
        3,
        :wx_const.wx_gl_minor_version(),
        3,
        :wx_const.wx_gl_doublebuffer(),
        0
      ]
    ]

    canvas = :wxGLCanvas.new(frame, opts ++ gl_attrib)
    ctx = :wxGLContext.new(canvas)
    :wxGLCanvas.setCurrent(canvas, ctx)

    send(self(), :update)

    {frame,
     %{
       frame: frame,
       canvas: canvas
     }}
  end

  @impl :wx_object
  def handle_event(wx(event: wxClose()), state) do
    {:stop, :normal, state}
  end

  @impl :wx_object
  def handle_info(:stop, %{canvas: canvas} = state) do
    :wxGLCanvas.destroy(canvas)

    {:stop, :normal, state}
  end

  @impl :wx_object
  def handle_info(:update, state) do
    render(state)

    {:noreply, state}
  end

  defp render(%{canvas: canvas} = state) do
    draw(state)
    :wxGLCanvas.swapBuffers(canvas)
    send(self(), :update)

    :ok
  end

  defp draw(%{canvas: _canvas} = _state) do
    :gl.clearColor(0.2, 0.1, 0.3, 1.0)
    :gl.clear(:gl_const.gl_color_buffer_bit())

    :ok
  end

  def child_spec(opts) do
    %{
      id: __MODULE__,
      start: {__MODULE__, :start_link, [opts]},
      restart: :permanent
    }
  end
end</code></pre>
<p>
And then we can add it to our <code class="inline">application.ex</code> and fire up <code class="inline">iex -S mix</code>:</p>
<pre><code class="elixir">defmodule Gltest.Application do
  # See https://hexdocs.pm/elixir/Application.html
  # for more information on OTP Applications
  @moduledoc false

  use Application

  @impl true
  def start(_type, _args) do
    children = [
      GlTest.Window
    ]

    # See https://hexdocs.pm/elixir/Supervisor.html
    # for other strategies and supported options
    opts = [strategy: :one_for_one, name: Gltest.Supervisor]
    Supervisor.start_link(children, opts)
  end
end</code></pre>
<p>
It’s important to note that we’re returning <code class="inline">{:ok, self()}</code> from <code class="inline">start_link/1</code>, because if 
you just return the value of <code class="inline">:wx_object.start_link/3</code> the process will crash, because what that 
returns does <em>not</em> match what <code class="inline">Supervisor.start_link/2</code> expects. That said, this <em>should</em> get 
a nice, Elixir-y purple window to appear on your screen. I’m running this code under WSL 2,
but it should work on any platform that supports Erlang and WX, which should be most of them. I know
that <a href="https://github.com/ScenicFramework/scenic">Scenic</a> has a specific driver for Nerves devices, so I wouldn’t expect that would work
out of the box, but I’d guess it works on MacOS.</p>
<p>
  <img src="/assets/images/09-10-2024-screenshot.png" alt="A working purple window">
</p>

  </article>

      </main>
      <footer class="mt-24 bg-bludacris p-4 text-center">
        © Andy LeClair 2024 | <a href="/atom.xml">Atom</a> | <a href="/feed.xml">RSS</a>
      </footer>
    </div>
  </body>
</html>